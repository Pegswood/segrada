function escapeHTML(a){if(typeof a=="string"){return a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}return""}(function(e){var o=function(v){return function w(z,x){var y=e.ajax({url:v+encodeURIComponent(z),async:false});x(JSON.parse(y.responseText))}};var p=function(){return function v(A,w){var z=urlSegradaNodeSearch+encodeURIComponent(A);var x=e(".sg-node-search").filter(":focus");var C=e("#"+x.attr("data-select-id")+" option").filter(":selected");var B=C.attr(x.attr("data-attr"));if(B!=null&&B.length>0){z+="&tags="+encodeURIComponent(B)}var y=e.ajax({url:z,async:false});w(JSON.parse(y.responseText))}};function n(v){return v.replace(/;jsessionid=([^?]*)/,"")}urlSegradaPictogramSearch=n(urlSegradaPictogramSearch);urlSegradaPictogramFile=n(urlSegradaPictogramFile);urlSegradaTagSearch=n(urlSegradaTagSearch);urlSegradaNodeSearch=n(urlSegradaNodeSearch);urlSegradaFileSearch=n(urlSegradaFileSearch);urlSegradaSourceSearch=n(urlSegradaSourceSearch);urlSegradaRelationAdd=n(urlSegradaRelationAdd);var j=false;var h=new vis.DataSet([]);var r=new vis.DataSet([]);var b=null;var s=null;var c=null;e.fn.onEnter=function(v){this.bind("keypress",function(w){if(w.keyCode==13){v.apply(this,[w])}});return this};var k=new RegExp(/<([^\s]+).*?id="([^"]*?)".*?>/i);function g(A,z,y,v,x){var w=urlSegradaPictogramSearch+encodeURIComponent(x);e.getJSON(w,function(C){var B=[];e.each(C,function(D,E){var F=e("<div/>").text(E.title).html();B.push('<div class="col-xs-1 sg-no-padding-right"><a class="sg-pictogram-modal-link" href="#" data-id="'+E.id+'" data-uid="'+E.uid+'" title="'+F+'"><img src="'+urlSegradaPictogramFile+E.uid+'" width="24" height="24" alt="'+F+'" /></a></div>')});z.html("<div class='row'>"+B.join("")+"</div>");e("a",z).click(function(G){var F=e(this).attr("data-id");var E=e(this).attr("data-uid");var D=e("<div/>").text(e(this).attr("title")).html();e("#value-"+y,v).val(F);e("#preview-"+y,v).html('<img src="'+urlSegradaPictogramFile+E+'" width="24" height="24" alt="'+D+'" /> '+D);e("#clear-"+y,v).show();G.preventDefault();A.modal("hide")})}).fail(function(){alert("ERROR")})}function l(v){e.get(v,function(z){var y=z.match(k);if(y!=null&&y.length>=2){e("#"+y[2]).remove()}var x=e("#sg-data");x.prepend(z);var w=x.children(":first");m(w);e("html, body").animate({scrollTop:w.offset().top},500)}).fail(function(){alert("ERROR")})}function m(v){v=v||e("body");e(".sg-data").addClass("sg-dynamic-data");e(".sg-headbox-right").show();e(".sg-dynamic-hide").hide();e(".sg-data-add",v).click(function(x){l(e(this).attr("href"));x.preventDefault()});e(".sg-control-form",v).ajaxForm({beforeSubmit:function(x,z,A){var B=z.attr("data-target-id");if(typeof B=="undefined"||B==null||B.length==0){B="#sg-control";i()}var y=e(B);y.wrapInner("<div class='sg-disabled'></div>");y.prepend(e("#sg-wait").html());return true},success:function(z,B,C,y){var A=y.attr("data-target-id");if(typeof A=="undefined"||A==null||A.length==0){A="#sg-control"}var x=e(A);x.html(z);m(x)},error:function(z,B,C,y){var A=y.attr("data-target-id");if(typeof A=="undefined"||A==null||A.length==0){A="#sg-control"}var x=e(A);x.html(z.statusText);alert("Error "+z.status+"\n"+z.statusText)}});e(".sg-submit-form",v).change(function(){e(this).closest("form").submit()});e(".sg-control-set",v).click(function(A){var z=e(this);var y=z.attr("data-target-id");if(typeof y=="undefined"||y==null||y.length==0){y="#sg-control";i()}var x=e(y);x.wrapInner("<div class='sg-disabled'></div>");x.prepend(e("#sg-wait").html());e.get(z.attr("href"),function(B){x.html(B);m(x)}).fail(function(){alert("ERROR")});A.preventDefault()});e("[data-data-dblclick]",v).dblclick(function(){e.get(e(this).attr("data-data-dblclick"),function(A){var z=A.match(k);if(z!=null&&z.length>=2){e("#"+z[2]).remove()}var y=e("#sg-data");y.prepend(A);var x=y.children(":first");m(x);e("html, body").animate({scrollTop:x.offset().top},500)}).fail(function(){alert("ERROR")})});e("tr [data-confirm]",v).click(function(y){var x=e(this);if(confirm(x.attr("data-confirm"))){var z=x.closest("tr");z.addClass("sg-disabled");e.get(x.attr("href"),function(A){z.slideUp("fast",function(){z.remove()})}).fail(function(){alert("ERROR")})}y.preventDefault()});e(".sg-control-confirm",v).click(function(z){var y=e(this);if(confirm(y.attr("data-confirm"))){var x=e("#"+y.attr("data-target"));x.addClass("sg-disabled");e.get(y.attr("href"),function(A){x.fadeOut("slow",function(){x.remove()})}).fail(function(){alert("ERROR")})}z.preventDefault()});e(".sg-replace-content",v).on("shown.bs.tab",function(z){var y=e(e(this).attr("href"));var x=e(this).attr("data-url");e.get(x,function(A){y.html(A);m(y)}).fail(function(){alert("ERROR")});e(this).removeClass("sg-replace-content");e(this).unbind("shown.bs.tab")});e(".sg-data-close",v).click(function(x){e(this).parent().parent().fadeOut("fast",function(){e(this).remove()})});e("input.sg-fileupload",v).fileinput({showUpload:false});e("input.sg-fileupload-small",v).fileinput({showUpload:false,previewSettings:{image:{width:"auto",height:"24px"}}});e(".sg-pictogram-modal",v).on("shown.bs.modal",function(){var A=e(this);var z=A.attr("id");var y=e("#container-"+z,A);var x=e("#filter-"+z,A);x.on("input propertychange paste",function(){g(A,y,z,v,e(this).val())}).onEnter(function(){var C=e(".sg-pictogram-modal-link",y).first();if(C.length>0){var E=C.attr("data-id");var D=C.attr("data-id");var B=e("<div/>").text(C.attr("title")).html();e("#value-"+z,v).val(E);e("#preview-"+z,v).html('<img src="'+urlSegradaPictogramFile+D+'" width="24" height="24" alt="'+B+'" /> '+B);e("#clear-"+z,v).show();A.modal("hide")}});if(x.val()===""){g(A,y,z,v,"")}});e(".sg-pictogram-chooser",v).click(function(x){e("#"+e(this).attr("data-id")).modal("show");x.preventDefault()});e(".sg-pictogram-clearer",v).click(function(y){var x=e(this).attr("data-id");e("#value-"+x,v).val("");e("#preview-"+x,v).html("");e(this).hide();y.preventDefault()});e(".sg-source-ref-modal",v).on("shown.bs.modal",function(){var z=e(this);var y=z.attr("id");var x=e(".modal-body",z);e.get(z.attr("data-href"),function(A){x.html(A);e("form",x).ajaxForm({beforeSubmit:function(B,C,D){C.wrapInner("<div class='sg-disabled'></div>");C.prepend(e("#sg-wait").html());return true},success:function(C,E,F,B){var D=e(z.attr("data-target"));D.html(C);m(D);z.modal("hide")},error:function(C,D,E,B){alert("Error "+C.status+"\n"+C.statusText)}})}).fail(function(){alert("ERROR")})}).on("hidden.bs.modal",function(){e(".modal-body",e(this)).html(e("#sg-wait").html())});e(".sg-source-ref-editor",v).click(function(y){var x=e("#"+e(this).attr("data-id"));x.attr("data-href",e(this).attr("href"));x.modal("show");y.preventDefault()});e(".sg-taglist-contract",v).each(function(){var x=e("span",e(this));if(x.length>1){x.hide().filter(":first-child").show().after('<span class="sg-tag-show label label-default"><i class="fa fa-plus"></i></span>');e("span.sg-tag-show",e(this)).click(function(){e(this).remove();x.show()})}});e("select.sg-colorpicker",v).simplepicker({theme:"fontawesome"});e("select.sg-tags",v).each(function(){var x=e(this);x.tagsinput({trimValue:true,confirmKeys:[13],typeaheadjs:{name:"tags",displayKey:"title",valueKey:"title",source:o(urlSegradaTagSearch)}});x.on("itemRemoved",function(y){x.find('option[value="'+y.item+'"]').remove()})});e("input.sg-node-search",v).each(function(){var y=e(this);var x=e("#"+y.attr("data-id"));y.typeahead({hint:true,highlight:true,minLength:1},{name:"node",displayKey:"title",valueKey:"id",source:p()}).bind("typeahead:selected",function(A,z){x.val(z.id)}).bind("keyup",function(){if(!this.value){x.val("")}})});e("input.sg-file-search",v).each(function(){var y=e(this);var x=e("#"+y.attr("data-id"));y.typeahead({hint:true,highlight:true,minLength:1},{name:"file",displayKey:"title",valueKey:"id",source:o(urlSegradaFileSearch)}).bind("typeahead:selected",function(A,z){x.val(z.id)}).bind("keyup",function(){if(!this.value){x.val("")}})});e("input.sg-source-search",v).each(function(){var y=e(this);var x=e("#"+y.attr("data-id"));y.typeahead({hint:true,highlight:true,minLength:1},{name:"source",displayKey:"title",valueKey:"id",source:o(urlSegradaSourceSearch)}).bind("typeahead:selected",function(A,z){x.val(z.id)}).bind("keyup",function(){if(!this.value){x.val("")}})});e(".sg-link-external",v).click(function(z){var x=e(this).attr("href");var y=window.open(x,"_blank");y.focus();z.preventDefault()});e("form.sg-data-form",v).ajaxForm({beforeSubmit:function(x,y,z){e(":input",y).attr("disabled",true);e("button.btn-primary",y).append(" "+e("#sg-wait-btn").html());return true},success:function(z,B,C,x){var A=x.attr("data-id");if(typeof A!=="undefined"){A=e("#"+A)}A=A||x;A.replaceWith(z);var y=z.match(k);if(y!=null&&y.length>=2){m(e("#"+y[2]))}},error:function(y,z,A,x){e(":input",x).attr("disabled",false);alert("Error "+y.status+"\n"+y.statusText)}});e("form.sg-simple-form",v).ajaxForm({beforeSubmit:function(x,y,z){e(":input",y).attr("disabled",true);var A=y.attr("data-id");if(typeof A!=="undefined"){A=e("#"+A)}A=A||y;A.html(e("#sg-wait"));return true},success:function(y,A,B,x){var z=x.attr("data-id");if(typeof z!=="undefined"){z=e("#"+z)}z=z||x;z.html(y);e(":input",x).attr("disabled",false)},error:function(y,z,A,x){e(":input",x).attr("disabled",false);alert("Error "+y.status+"\n"+y.statusText)}});e(".sg-periods").each(function(){var x=e(this);var z=x.attr("id");var y=e(".sg-period-form",x);e(".sg-period-add",x).click(function(B){e(this).hide();var A=e(".sg-period-form-add",x);A.show();e(".sg-period-form-period",A).change(function(C){if(e(this).is(":checked")){e(".sg-period-toggle",A).show()}else{e(".sg-period-toggle",A).hide()}});B.preventDefault()});y.ajaxForm({beforeSubmit:function(A,B,C){x.addClass("disabled");return true},success:function(B,C,D,A){x.replaceWith(B);m(e("#"+z))},error:function(B,C,D,A){x.removeClass("disabled");alert("Error "+B.status+"\n"+B.statusText)}})});e(".sg-ajax-modal",v).click(function(A){var y=e("#sg-modal");var x=e(".modal-body-inner",y);var z=e(".modal-loading",y);e("h4",y).html(e(this).attr("data-title"));x.html("");x.hide();z.show();y.modal("show");e.get(e(this).attr("href"),function(B){z.hide();x.html(B);x.show();m(x)}).fail(function(){alert("ERROR")});A.preventDefault()});e(".sg-ajax-modal-form",v).ajaxForm({beforeSubmit:function(x,y,B){var A=e("#sg-modal");var z=e(".modal-body-inner",A);var C=e(".modal-loading",A);z.hide();C.show();return true},success:function(B,C,D,x){var z=e("#sg-modal");var y=e(".modal-body-inner",z);var A=e(".modal-loading",z);y.html(B);y.show();A.hide();m(y);z=e("#sg-modal");e(".sg-update-period",z).each(function(){var F=e(this).attr("data-id");var G=e(F);if(G.length>0){for(var E=0;E<3;E++){e("td:eq("+E+")",G).html(e("div:eq("+E+")",e(this)).html())}}})},error:function(B,C,D,x){var z=e("#sg-modal");var y=e(".modal-body-inner",z);var A=e(".modal-loading",z);y.html(B);y.show();A.hide();m(y)}});e("a.sg-graph-update",v).click(function(x){t(e(this).attr("href"));x.preventDefault()});e("a.sg-graph-replace",v).click(function(y){f();t(e(this).attr("href"));var z=e(this).attr("data-title");if(z.length!=0){s=z}var x=e(this).attr("data-uid");if(x.length!=0){c=x}y.preventDefault()});e("div.sg-tag-hierarchy",v).each(function(){var C=e(this);var x=e(".sg-tag-hierarchy-graph",C);e(".sg-child-tags",C).hide();x.addClass("sg-margin-top sg-margin-bottom");var D=e(".sg-tag-hierarchy-data",C);var z=D.attr("data-center");var G=0;var F=0;var y=[];var B=[];e("div",D).each(function(){var L=e(this);var J=L.attr("data-id");var K=L.attr("data-level");y.push({id:J,label:L.html(),level:K,url:L.attr("data-url")});if(K=="0"){B.push({from:J,to:z});G++}else{if(K=="2"){B.push({from:z,to:J});F++}}});var E=G>F?(G==0?1:G):F;x.css({width:"100%",height:(E*50)+"px",border:"1px solid #ccc"});var A={nodes:new vis.DataSet(y),edges:new vis.DataSet(B)};y=null;B=null;var I={edges:{smooth:{type:"cubicBezier",forceDirection:"horizontal",roundness:0.6}},nodes:{shape:"box"},layout:{hierarchical:{direction:"LR"}}};var H=new vis.Network(x.get(0),A,I);H.on("doubleClick",function(L){var J=null;if(L.nodes.length>0){var K=A.nodes.get(L.nodes[0]);if(K!=null&&K.url!=null){J=K.url}}if(J!=null){l(J)}})});for(var w=0;w<afterAjaxHooks.length;w++){afterAjaxHooks[w](v)}}function d(){if(!j){j=true;var v=document.getElementById("sg-graph");var x={nodes:h,edges:r};var w={locale:e("html").attr("lang"),locales:{de:{edit:"Änderungsmodus",del:"Lösche Auswahl",back:"Zurück",addNode:"Knoten hinzufügen",addEdge:"Verknüpfung hinzufügen",editNode:"Knoten editieren",editEdge:"Verknüpfung editieren",addDescription:"Klicke auf eine freie Stelle, um einen neuen Knoten zu plazieren.",edgeDescription:"Klicke auf einen Knoten und ziehe die Verknüpfung zu einem anderen Knoten, um diese zu verbinden.",editEdgeDescription:"Klicke auf die Verbindungspunkte und ziehe diese auf einen Knoten, um sie zu verbinden.",createEdgeError:"Es ist nicht möglich, Verknüpfungen mit Clustern zu verbinden.",deleteClusterError:"Cluster können nicht gelöscht werden.",editClusterError:"Cluster können nicht editiert werden."},en:{edit:"Toggle edit",del:"Delete selected",back:"Back",addNode:"Add Node",addEdge:"Add Relation",editNode:"Edit Node",editEdge:"Edit Relation",addDescription:"Click in an empty space to place a new node.",edgeDescription:"Click on a node and drag the relation to another node to connect them.",editEdgeDescription:"Click on the control points and drag them to a node to connect to it.",createEdgeError:"Cannot link relations to a cluster.",deleteClusterError:"Clusters cannot be deleted.",editClusterError:"Clusters cannot be edited."}},manipulation:{enabled:true,addNode:false,addEdge:function(z,A){var y=urlSegradaRelationAdd.replace("XFROMX",z.from.replace(/#([0-9]+):([0-9]+)/,"$1-$2")).replace("XTOX",z.to.replace(/#([0-9]+):([0-9]+)/,"$1-$2")).replace("&amp;","&");l(y);return false},editNode:function(y,z){return false},editEdge:function(y,z){return false},deleteNode:function(y,z){return false},deleteEdge:function(y,z){return false}},nodes:{shape:"icon",color:{border:"#000",background:"#fff"}},edges:{font:{size:10},labelHighlightBold:false,selectionWidth:0,arrows:{to:true},smooth:{type:"cubicBezier"}},groups:{node:{icon:{code:"\uf192",color:"#000000"}},tag:{shape:"box",color:{border:"#5bc0de",background:"#5bc0de",highlight:{background:"#2B7CE9"}},font:{color:"#ffffff",size:12}}},physics:{barnesHut:{springLength:120}}};b=new vis.Network(v,x,w);b.on("doubleClick",function(B){var y=null;if(B.nodes.length>0){var A=h.get(B.nodes[0]);if(A!=null&&A.url!=null){y=A.url}}else{if(B.edges.length>0){var z=r.get(B.edges[0]);if(z!=null&&z.url!=null){y=z.url}}}if(y!=null){l(y)}})}}function i(){var v=e("#sg-toggle-graph");if(v.hasClass("active")){v.removeClass("active");e(".fa-share-alt-square",v).addClass("fa-share-alt").removeClass("fa-share-alt-square");b.storePositions();e("#sg-graph-container").hide();e("#sg-control").show();b.destroy();j=false}}function q(){var v=e("#sg-toggle-graph");if(!v.hasClass("active")){v.addClass("active");e(".fa-share-alt",v).addClass("fa-share-alt-square").removeClass("fa-share-alt");e("#sg-control").hide();e("#sg-graph-container").show();d()}}function t(w){if(w==null){alert("Null url!");return}q();u();var y=[];var A=[];var v=h.get({fields:["id"]});var x;for(x=0;x<v.length;x++){y.push(v[x].id)}v=r.get({fields:["id"]});for(x=0;x<v.length;x++){A.push(v[x].id)}var z=e("#sg-graph-container").attr("data-csrf");e.ajax({url:w,type:"POST",dataType:"json",headers:{"Content-Type":"application/json","X-CSRF-Token":z},data:JSON.stringify({nodes:y,edges:A}),success:function(C,D,B){a();if(C==null){alert("NULL data");return}if(C.error!=null){alert(C.error);return}if(C.nodes!=null&&C.nodes.length>0){h.update(C.nodes)}if(C.edges!=null&&C.edges.length>0){r.update(C.edges)}if(C.removeNodes!=null&&C.removeNodes.length>0){h.remove(C.removeNodes)}if(C.removeEdges!=null&&C.removeEdges.length>0){r.remove(C.removeEdges)}if(C.highlightNode!=null){b.unselectAll();b.selectNodes([C.highlightNode],false)}b.fit()}})}function f(){r.clear();h.clear();c="";s=""}function u(){var v=e("#sg-graph");v.css("background",'url("'+v.attr("data-bg")+'") no-repeat center center')}function a(){e("#sg-graph").css("background","transparent")}e.event.special.destroyed={remove:function(v){if(v.handler){v.handler()}}};e(document).ready(function(){e("#sg-close-all").click(function(v){e(".sg-data").fadeOut("fast",function(){e(this).remove()});v.preventDefault()});e(".sg-locale").click(function(v){e.get(e(this).attr("href"),function(x){var w=e("#sg-base").html();if(x!=""){window.location.href=w}}).fail(function(){alert("ERROR")});v.preventDefault()});e("#sg-toggle-graph").click(function(v){if(e(this).hasClass("active")){i()}else{q()}v.preventDefault()});e("#sg-graph-action-remove").click(function(w){var v=b.getSelection();if(v.edges.length>0){r.remove(v.edges)}if(v.nodes.length>0){h.remove(v.nodes)}w.preventDefault()});e("#sg-graph-action-restart").click(function(v){f();v.preventDefault()});e("#sg-graph-action-reload").click(function(v){b.destroy();j=false;d();v.preventDefault()});e("#sg-graph-action-fit").click(function(v){b.fit();v.preventDefault()});e("#sg-graph-close").click(function(v){i();v.preventDefault()});e("#sg-graph-action-load").click(function(v){e("#sg-graph-modal-load").modal();v.preventDefault()});e("#sg-graph-action-save").click(function(w){if(h.length>0){e("#title-sg-graph-save").val(s!==null?s:"");var v=e("#save-as-new-sg-graph-save").parent().parent().parent();if(c!==null){v.show()}else{v.hide()}e("#sg-graph-modal-save").modal()}w.preventDefault()});e("#sg-graph-modal-load").on("shown.bs.modal",function(){var x=e(this);var w=e(".modal-body",x);w.html(e("#sg-wait").html());var v=x.attr("data-url");e.get(v,function(A){var y=x.attr("data-get-url");var z="";A.forEach(function(B){z+="<li><a href='"+y+B.uid+"' data-uid='"+B.uid+"'>"+B.title+"</a></li>"});if(z!=""){z="<ul>"+z+"</ul>"}w.html(z);e("a",w).click(function(B){f();t(e(this).attr("href"));s=e(this).html();c=e(this).attr("data-uid");x.modal("hide");B.preventDefault()})})});e("#sg-graph-modal-save-frm").submit(function(z){z.preventDefault();var A=e("#title-sg-graph-save").val();var x=c;if(c!=null&&e("#save-as-new-sg-graph-save").is(":checked")){x=null}b.storePositions();var w=[];var v=[];h.forEach(function(B){w.push({id:B.id,x:B.x,y:B.y,group:B.group})});r.forEach(function(B){v.push({id:B.id,group:B.group})});var y={};e.post(e(this).attr("action"),{_csrf:e("#sg-graph-container").attr("data-csrf"),uid:x,title:A,type:"graph",data:JSON.stringify({nodes:w,edges:v})},function(B){s=A;c=B}).fail(function(){alert("ERROR")});e("#sg-graph-modal-save").modal("hide")});m(e("body"))})})(jQuery);